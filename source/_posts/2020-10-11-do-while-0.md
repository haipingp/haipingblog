---
title: do-while-0的作用
date: 2020-10-11 15:52:28
categories:
- C++ 
---

## 一、简介
* 许多宏定义中常常用到`do {} while(0)`这样的语句，例如：
``` cpp
#define SAFE_FREE(p) do{free(p);p=NULL;} while(0) 
```
* 条件0表示不循环，那这里为什么要这样写呢
<!-- more -->

## 二、防止在各个情景中使用时出现编译问题或误解
### 1. 情景1
* 如下代码：
``` cpp
if (NULL != p)
    SAFE_FREE(p)
else
    ...
```
会被展开成：
``` cpp
if (NULL != p)
    free(p); p=NULL;
else
    ...
```

* 展开之后有两个问题：
1. 因为if分支后有两个语句，导致else分支没有对应的if，编译失败；
2. 如果没有else分支，则SAFE\_FREE中的第二个语句无论if测试是否通过，都会执行。会造成误解。

### 2. 情景2
* 如果在情景1的定义中加上大括号，如下：
``` cpp
#define SAFE_FREE(p) {free(p); p=NULL;} 
```
由于每个语句后加分号是约定俗称的习惯，如下代码
``` cpp
if (NULL != p)
    { free(p); p=NULL; };
else 
   ...
```
展开后：
``` cpp
if (NULL != p)
    { free(p); p=NULL;};
else
    ...
```
上述代码又会发生编译问题

### 3. 使用了do-whiler-0可以解决上述问题 
* 宏展开的代码为
``` cpp
if (NULL != p)
    do { free(p); p=NULL; } while(0)
else 
    ...
```

