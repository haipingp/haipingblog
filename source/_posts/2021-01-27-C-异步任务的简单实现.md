---
title: C++异步任务的简单实现
date: 2021-01-27 22:52:48
categories:
- C++
---

## 一、`std::async`基础使用
* 下面是该函数的参数模板：
![async的函数模板](async.png)

<!--more-->

* `async`函数用于在特定时刻调用`fn`函数，无需等待`fn`函数的返回，就先返回一个`async`的函数调用结果
* 通过`async`返回的`future`对象得到`fn`函数的执行结果（通过future的成员函数`future::get`获得）
* 第二种函数模板中，可以通过第一个参数`launch policy`来指定创建线程的方式:
![launch policy](launch_policy.png)

    1. `launch::async`: 在调用async的同时，异步创建线程执行`fn`函数，并通过`get`获得共享状态(shared state)
    2. `launch::deferred`: 直到调用`get`函数再创建线程

* `future::get`: 若共享状态为ready，返回存储在共享状态中的值，若共享状态尚未ready，线程阻塞直到ready。当共享状态为ready，get函数立即返回，并且future对象不再valid。

* `future::valid`: 通过默认构造函数构造的future对象，valid()返回为false(除非通过move赋值)

## 二、异步任务的简单实现
1. 可以将比较耗时的异步任务函数用队列a存储，当队列a中任务攒到一定程度时，通过`std::async`创建异步线程执行a中的任务，并将返回的future对象存储在返回队列b中
2. 定时处理队列b中的返回对象，比如可以在这些对象中存储callback函数，等到共享状态valid并且ready的时候执行这些回调函数
3. 防止异步线程创建过多，可以等队列b中的返回对象处理完之后，再执行步骤1
